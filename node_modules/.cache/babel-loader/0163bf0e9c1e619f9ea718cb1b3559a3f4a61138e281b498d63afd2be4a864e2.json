{"ast":null,"code":"import _objectSpread from \"D:/\\u56FE\\u4E66\\u7BA1\\u7406\\u7CFB\\u7EDF/library/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport \"core-js/modules/es.array.find.js\";\nimport \"core-js/modules/es.array.is-array.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport \"core-js/modules/es.object.keys.js\";\nimport \"core-js/modules/es.object.to-string.js\";\n// 兼容全局localStorage获取当前用户\nfunction getCurrentUser() {\n  try {\n    if (typeof window !== \"undefined\") {\n      var w = eval(\"window\");\n      if (w && w.localStorage) {\n        var userStr = w.localStorage.getItem(\"user\");\n        if (userStr) return JSON.parse(userStr);\n      }\n    }\n  } catch (e) {\n    // intentionally ignore error\n  }\n  return null;\n}\nexport default {\n  name: \"BorrowForm\",\n  props: {\n    borrow: {\n      type: Object,\n      \"default\": function _default() {\n        return {};\n      }\n    },\n    visible: Boolean\n  },\n  emits: [\"update:visible\", \"submit\"],\n  data: function data() {\n    return {\n      form: {\n        userId: \"\",\n        userName: \"\",\n        bookId: \"\",\n        bookName: \"\",\n        borrowDate: \"\",\n        returnDate: \"\",\n        status: 0 // 默认数字类型，0=借阅中\n      },\n      bookOptions: [],\n      // 新增：图书下拉选项\n      userOptions: [] // 新增：用户下拉选项\n    };\n  },\n  mounted: function mounted() {\n    // 加载所有图书\n    this.fetchBooks();\n    this.fetchUsers(); // 新增\n  },\n  computed: {\n    isAdmin: function isAdmin() {\n      var user = getCurrentUser();\n      return user && user.role === 1;\n    },\n    rules: function rules() {\n      return {\n        userId: [{\n          required: true,\n          message: \"请输入借阅人\",\n          trigger: \"blur\"\n        }],\n        bookId: [{\n          required: true,\n          message: \"请输入图书\",\n          trigger: \"blur\"\n        }],\n        borrowDate: [{\n          required: true,\n          message: \"请选择借阅日期\",\n          trigger: \"change\"\n        }],\n        returnDate: this.isAdmin ? [] : [{\n          required: true,\n          message: \"请选择归还日期\",\n          trigger: \"change\"\n        }],\n        status: [{\n          required: true,\n          message: \"请选择状态\",\n          trigger: \"change\"\n        }]\n      };\n    },\n    statusText: function statusText() {\n      return this.form.returnDate ? \"已归还\" : \"借阅中\";\n    }\n  },\n  watch: {\n    borrow: {\n      immediate: true,\n      handler: function handler(val) {\n        if (val) {\n          // 自动根据归还日期设置状态\n          this.form = _objectSpread({}, val);\n          if (typeof this.form.status === \"string\") {\n            // 兼容旧数据\n            this.form.status = this.form.status === \"已归还\" ? 1 : 0;\n          }\n          if (!(\"status\" in val)) {\n            this.form.status = val.returnDate ? 1 : 0;\n          }\n        } else {\n          this.form = {\n            userId: \"\",\n            userName: \"\",\n            bookId: \"\",\n            bookName: \"\",\n            borrowDate: \"\",\n            returnDate: \"\",\n            status: 0\n          };\n        }\n      }\n    }\n  },\n  methods: {\n    fetchBooks: function fetchBooks() {\n      var _this = this;\n      // 假设有全局axios\n      this.$axios && this.$axios.get(\"/api/books\").then(function (res) {\n        _this.bookOptions = res.data || [];\n      });\n    },\n    fetchUsers: function fetchUsers() {\n      var _this2 = this;\n      this.$axios && this.$axios.get(\"/api/users\").then(function (res) {\n        // 兼容后端返回结构\n        _this2.userOptions = Array.isArray(res.data) ? res.data : res.data.data || [];\n      });\n    },\n    onBookChange: function onBookChange(bookId) {\n      var book = this.bookOptions.find(function (b) {\n        return b.id === bookId;\n      });\n      this.form.bookName = book ? book.title : \"\";\n    },\n    onUserChange: function onUserChange(userId) {\n      var user = this.userOptions.find(function (u) {\n        return u.id === userId;\n      });\n      this.form.userName = user ? user.realName || user.username : \"\";\n    },\n    submit: function submit() {\n      var _this3 = this;\n      this.$refs.form.validate(function (valid) {\n        if (!valid) return;\n        if (!_this3.form.bookId) {\n          _this3.$message && _this3.$message.warning(\"请选择图书（bookId）\");\n          return;\n        }\n        // 自动根据归还日期设置status为数字，后端需要0/1\n        var formCopy = _objectSpread({}, _this3.form);\n        formCopy.status = formCopy.returnDate ? 1 : 0; // 1=已归还, 0=借阅中\n        _this3.$emit(\"submit\", formCopy);\n        _this3.$emit(\"update:visible\", false);\n      });\n    }\n  }\n};","map":{"version":3,"names":["getCurrentUser","window","w","eval","localStorage","userStr","getItem","JSON","parse","e","name","props","borrow","type","Object","default","visible","Boolean","emits","data","form","userId","userName","bookId","bookName","borrowDate","returnDate","status","bookOptions","userOptions","mounted","fetchBooks","fetchUsers","computed","isAdmin","user","role","rules","required","message","trigger","statusText","watch","immediate","handler","val","_objectSpread","methods","_this","$axios","get","then","res","_this2","Array","isArray","onBookChange","book","find","b","id","title","onUserChange","u","realName","username","submit","_this3","$refs","validate","valid","$message","warning","formCopy","$emit"],"sources":["src/components/BorrowForm.vue"],"sourcesContent":["<template>\r\n  <el-dialog\r\n    :title=\"borrow && borrow.id ? '编辑借阅' : '添加借阅'\"\r\n    :visible=\"visible\"\r\n    width=\"400px\"\r\n    @close=\"$emit('update:visible', false)\"\r\n  >\r\n    <el-form ref=\"form\" :model=\"form\" :rules=\"rules\" label-width=\"90px\">\r\n      <el-form-item label=\"借阅人\" prop=\"userId\">\r\n        <el-select\r\n          v-model=\"form.userId\"\r\n          placeholder=\"请选择借阅人\"\r\n          filterable\r\n          :disabled=\"!isAdmin\"\r\n          @change=\"onUserChange\"\r\n        >\r\n          <el-option\r\n            v-for=\"user in userOptions\"\r\n            :key=\"user.id\"\r\n            :label=\"user.realName || user.username\"\r\n            :value=\"user.id\"\r\n          />\r\n        </el-select>\r\n      </el-form-item>\r\n      <el-form-item label=\"图书\" prop=\"bookId\">\r\n        <el-select\r\n          v-model=\"form.bookId\"\r\n          placeholder=\"请选择图书\"\r\n          filterable\r\n          :disabled=\"!isAdmin\"\r\n          @change=\"onBookChange\"\r\n        >\r\n          <el-option\r\n            v-for=\"book in bookOptions\"\r\n            :key=\"book.id\"\r\n            :label=\"book.title\"\r\n            :value=\"book.id\"\r\n          />\r\n        </el-select>\r\n      </el-form-item>\r\n      <el-form-item label=\"借阅日期\" prop=\"borrowDate\">\r\n        <el-date-picker\r\n          v-model=\"form.borrowDate\"\r\n          type=\"date\"\r\n          placeholder=\"选择日期\"\r\n          style=\"width: 100%\"\r\n          :disabled=\"!isAdmin\"\r\n        />\r\n      </el-form-item>\r\n      <el-form-item label=\"归还日期\" prop=\"returnDate\">\r\n        <el-date-picker\r\n          v-model=\"form.returnDate\"\r\n          type=\"date\"\r\n          placeholder=\"选择日期\"\r\n          style=\"width: 100%\"\r\n        />\r\n      </el-form-item>\r\n      <!-- 状态字段仅添加时显示，编辑时不显示 -->\r\n      <el-form-item v-if=\"!borrow || !borrow.id\" label=\"状态\" prop=\"status\">\r\n        <el-select\r\n          v-model=\"form.status\"\r\n          placeholder=\"请选择\"\r\n          :disabled=\"!isAdmin\"\r\n        >\r\n          <el-option label=\"在借阅\" :value=\"0\">\r\n            <template #default>\r\n              <el-tag type=\"success\"> 在借阅 </el-tag>\r\n            </template>\r\n          </el-option>\r\n          <el-option label=\"已归还\" :value=\"1\">\r\n            <template #default>\r\n              <el-tag type=\"info\"> 已归还 </el-tag>\r\n            </template>\r\n          </el-option>\r\n        </el-select>\r\n      </el-form-item>\r\n    </el-form>\r\n    <div v-if=\"form.borrowDate\" style=\"margin-top: 10px; text-align: right\">\r\n      <el-tag\r\n        :type=\"statusText === '借阅中' ? 'success' : 'info'\"\r\n        effect=\"light\"\r\n      >\r\n        {{ statusText }}\r\n      </el-tag>\r\n    </div>\r\n    <template #footer>\r\n      <div class=\"dialog-footer\">\r\n        <el-button @click=\"$emit('update:visible', false)\"> 取 消 </el-button>\r\n        <el-button type=\"primary\" @click=\"submit\"> 确 定 </el-button>\r\n      </div>\r\n    </template>\r\n  </el-dialog>\r\n</template>\r\n\r\n<script>\r\n// 兼容全局localStorage获取当前用户\r\nfunction getCurrentUser() {\r\n  try {\r\n    if (typeof window !== \"undefined\") {\r\n      const w = eval(\"window\");\r\n      if (w && w.localStorage) {\r\n        const userStr = w.localStorage.getItem(\"user\");\r\n        if (userStr) return JSON.parse(userStr);\r\n      }\r\n    }\r\n  } catch (e) {\r\n    // intentionally ignore error\r\n  }\r\n  return null;\r\n}\r\nexport default {\r\n  name: \"BorrowForm\",\r\n  props: {\r\n    borrow: {\r\n      type: Object,\r\n      default: () => ({}),\r\n    },\r\n    visible: Boolean,\r\n  },\r\n  emits: [\"update:visible\", \"submit\"],\r\n  data() {\r\n    return {\r\n      form: {\r\n        userId: \"\",\r\n        userName: \"\",\r\n        bookId: \"\",\r\n        bookName: \"\",\r\n        borrowDate: \"\",\r\n        returnDate: \"\",\r\n        status: 0, // 默认数字类型，0=借阅中\r\n      },\r\n      bookOptions: [], // 新增：图书下拉选项\r\n      userOptions: [], // 新增：用户下拉选项\r\n    };\r\n  },\r\n  mounted() {\r\n    // 加载所有图书\r\n    this.fetchBooks();\r\n    this.fetchUsers(); // 新增\r\n  },\r\n  computed: {\r\n    isAdmin() {\r\n      const user = getCurrentUser();\r\n      return user && user.role === 1;\r\n    },\r\n    rules() {\r\n      return {\r\n        userId: [{ required: true, message: \"请输入借阅人\", trigger: \"blur\" }],\r\n        bookId: [{ required: true, message: \"请输入图书\", trigger: \"blur\" }],\r\n        borrowDate: [\r\n          { required: true, message: \"请选择借阅日期\", trigger: \"change\" },\r\n        ],\r\n        returnDate: this.isAdmin\r\n          ? []\r\n          : [{ required: true, message: \"请选择归还日期\", trigger: \"change\" }],\r\n        status: [{ required: true, message: \"请选择状态\", trigger: \"change\" }],\r\n      };\r\n    },\r\n    statusText() {\r\n      return this.form.returnDate ? \"已归还\" : \"借阅中\";\r\n    },\r\n  },\r\n  watch: {\r\n    borrow: {\r\n      immediate: true,\r\n      handler(val) {\r\n        if (val) {\r\n          // 自动根据归还日期设置状态\r\n          this.form = { ...val };\r\n          if (typeof this.form.status === \"string\") {\r\n            // 兼容旧数据\r\n            this.form.status = this.form.status === \"已归还\" ? 1 : 0;\r\n          }\r\n          if (!(\"status\" in val)) {\r\n            this.form.status = val.returnDate ? 1 : 0;\r\n          }\r\n        } else {\r\n          this.form = {\r\n            userId: \"\",\r\n            userName: \"\",\r\n            bookId: \"\",\r\n            bookName: \"\",\r\n            borrowDate: \"\",\r\n            returnDate: \"\",\r\n            status: 0,\r\n          };\r\n        }\r\n      },\r\n    },\r\n  },\r\n  methods: {\r\n    fetchBooks() {\r\n      // 假设有全局axios\r\n      this.$axios &&\r\n        this.$axios.get(\"/api/books\").then((res) => {\r\n          this.bookOptions = res.data || [];\r\n        });\r\n    },\r\n    fetchUsers() {\r\n      this.$axios &&\r\n        this.$axios.get(\"/api/users\").then((res) => {\r\n          // 兼容后端返回结构\r\n          this.userOptions = Array.isArray(res.data)\r\n            ? res.data\r\n            : res.data.data || [];\r\n        });\r\n    },\r\n    onBookChange(bookId) {\r\n      const book = this.bookOptions.find((b) => b.id === bookId);\r\n      this.form.bookName = book ? book.title : \"\";\r\n    },\r\n    onUserChange(userId) {\r\n      const user = this.userOptions.find((u) => u.id === userId);\r\n      this.form.userName = user ? user.realName || user.username : \"\";\r\n    },\r\n    submit() {\r\n      this.$refs.form.validate((valid) => {\r\n        if (!valid) return;\r\n        if (!this.form.bookId) {\r\n          this.$message && this.$message.warning(\"请选择图书（bookId）\");\r\n          return;\r\n        }\r\n        // 自动根据归还日期设置status为数字，后端需要0/1\r\n        let formCopy = { ...this.form };\r\n        formCopy.status = formCopy.returnDate ? 1 : 0; // 1=已归还, 0=借阅中\r\n        this.$emit(\"submit\", formCopy);\r\n        this.$emit(\"update:visible\", false);\r\n      });\r\n    },\r\n  },\r\n};\r\n</script>\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}